<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Softlogic — Job Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;font-family:Inter,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,#071024 0%, #071a2a 100%);color:#e6eef6}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:18px}
    header h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    form .row{display:flex;gap:8px;margin-bottom:8px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:#042023;cursor:pointer;font-weight:600}
    .menu{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .menu button{background:transparent;color:var(--muted);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .menu button.active{color:var(--accent);border-color:rgba(6,182,212,0.12);box-shadow:0 4px 12px rgba(6,182,212,0.06)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .actions button{margin-right:6px}
    .small{font-size:12px;padding:6px 8px}
    .config{display:flex;flex-direction:column;gap:8px}
    .notice{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:var(--muted);font-size:13px}
    footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:980px){.grid{grid-template-columns:1fr} .wrap{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://supun123456789.github.io/softlogic/favicon.png" alt="logo" width="44" height="44" style="border-radius:10px;object-fit:cover">
      <div>
        <h1>Softlogic — Job Manager</h1>
        <div class="muted">Submit, view, update jobs — auto sync to GitHub or keep local</div>
      </div>
    </header>

    <div class="grid" style="margin-top:18px">
      <section class="card">
        <h3>New / Edit Job</h3>
        <form id="jobForm">
          <input type="hidden" id="editingIndex" value="-1">
          <div class="row"><input id="customer" placeholder="Customer name (e.g. Vivin)" required></div>
          <div class="row"><input id="model" placeholder="Model" required></div>
          <div class="row"><input id="refNo" placeholder="Reference No"></div>
          <div class="row"><input id="qty" placeholder="Qty" type="number" min="0" value="1"></div>
          <div class="row"><textarea id="notes" placeholder="Notes (optional)" rows="3"></textarea></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button type="submit">Save job</button>
            <button type="button" id="saveLocal" class="small">Save local only</button>
            <button type="button" id="exportXlsx" class="small">Export Excel</button>
          </div>
          <div style="margin-top:8px" class="notice">By default the app will auto-upload the jobs file to your configured GitHub repo (you can disable token or leave blank to keep local storage only).</div>
        </form>

        <div style="margin-top:12px">
          <h4>Configuration</h4>
          <div class="config">
            <input id="ghUser" placeholder="GitHub owner (username or org), e.g. supun123456789">
            <input id="ghRepo" placeholder="Repo name, e.g. softlogic-files">
            <input id="ghPath" placeholder="File path on repo, e.g. data/jobs.xlsx">
            <input id="ghToken" placeholder="GitHub Personal Access Token (keep secret)" type="password">
            <div style="display:flex;gap:8px">
              <button id="testDownload" class="small">Download from GitHub</button>
              <button id="clearLocal" class="small">Clear local</button>
            </div>
            <div class="muted">Tip: It's safer to use a server-side token (this demo allows client-side token for quick testing only).</div>
          </div>
        </div>
      </section>

      <aside class="card">
        <h3>Menu</h3>
        <div class="menu" role="tablist">
          <button id="tabAll" class="active">All Jobs</button>
          <button id="tabOutgoing">By Customer</button>
          <button id="tabSearch">Search / Filter</button>
        </div>

        <div id="listArea" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <h4>Quick actions</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button id="downloadCsv" class="small">Download CSV</button>
            <button id="syncGithub" class="small">Sync to GitHub now</button>
            <button id="loadFromLocal" class="small">Load local</button>
          </div>
        </div>
      </aside>
    </div>

    <footer class="muted">Made for Supun — convert to Android WebView or host on GitHub Pages. Keep tokens secret. Uploads use GitHub REST API v3.</footer>
  </div>

  <!-- SheetJS for Excel export (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Data handling
    const STORAGE_KEY = 'softlogic_jobs_v1';
    let jobs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    // Load persisted config in sessionStorage
    document.getElementById('ghUser').value = sessionStorage.getItem('ghUser')||'';
    document.getElementById('ghRepo').value = sessionStorage.getItem('ghRepo')||'';
    document.getElementById('ghPath').value = sessionStorage.getItem('ghPath')||'jobs.xlsx';
    document.getElementById('ghToken').value = sessionStorage.getItem('ghToken')||'';

    // helpers
    function saveLocalData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
    }

    function renderList(){
      const area = document.getElementById('listArea');
      if(!jobs.length) return area.innerHTML = '<div class="muted">No jobs yet — add one from the left.</div>';
      let html = '<table><thead><tr><th>#</th><th>Customer</th><th>Model</th><th>Ref</th><th>Qty</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
      jobs.forEach((j,i)=>{
        html += `<tr><td>${i+1}</td><td>${escapeHtml(j.customer)}</td><td>${escapeHtml(j.model)}</td><td>${escapeHtml(j.refNo||'')}</td><td>${j.qty||''}</td><td>${escapeHtml(j.notes||'')}</td><td class="actions"><button onclick="editJob(${i})" class="small">Edit</button><button onclick="deleteJob(${i})" class="small">Delete</button></td></tr>`;
      });
      html += '</tbody></table>';
      area.innerHTML = html;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\\':'\\\\','"':'&quot;'}[c])); }

    function addJob(obj){ jobs.push(obj); saveLocalData(); renderList(); }
    function updateJob(index,obj){ jobs[index]=obj; saveLocalData(); renderList(); }
    function deleteJob(index){ if(!confirm('Delete this job?')) return; jobs.splice(index,1); saveLocalData(); renderList(); }

    // Form handling
    document.getElementById('jobForm').addEventListener('submit', e=>{
      e.preventDefault();
      const idx = parseInt(document.getElementById('editingIndex').value||-1,10);
      const job = {
        customer: document.getElementById('customer').value.trim(),
        model: document.getElementById('model').value.trim(),
        refNo: document.getElementById('refNo').value.trim(),
        qty: Number(document.getElementById('qty').value)||0,
        notes: document.getElementById('notes').value.trim(),
        createdAt: new Date().toISOString()
      };
      if(idx>=0){ updateJob(idx,job); document.getElementById('editingIndex').value='-1'; }
      else { addJob(job); }
      // Auto upload to GitHub if configured
      maybeAutoUpload();
      e.target.reset();
    });

    document.getElementById('saveLocal').addEventListener('click', ()=>{ saveLocalData(); alert('Saved to local storage'); });

    document.getElementById('exportXlsx').addEventListener('click', ()=>{
      if(!jobs.length){ alert('No data to export'); return; }
      const ws = XLSX.utils.json_to_sheet(jobs.map((j,i)=>({No:i+1,Customer:j.customer,Model:j.model,RefNo:j.refNo,Qty:j.qty,Notes:j.notes,Created:j.createdAt})))
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Jobs');
      XLSX.writeFile(wb,'jobs.xlsx');
    });

    // List actions
    window.editJob = function(i){ const j = jobs[i]; document.getElementById('customer').value=j.customer; document.getElementById('model').value=j.model; document.getElementById('refNo').value=j.refNo; document.getElementById('qty').value=j.qty; document.getElementById('notes').value=j.notes; document.getElementById('editingIndex').value=i; window.scrollTo({top:0,behavior:'smooth'}); }
    window.deleteJob = deleteJob;

    // Menu tabs
    document.getElementById('tabAll').addEventListener('click', ()=>{ setActive('tabAll'); renderList(); });
    document.getElementById('tabOutgoing').addEventListener('click', ()=>{ setActive('tabOutgoing'); renderGroupedByCustomer(); });
    document.getElementById('tabSearch').addEventListener('click', ()=>{ setActive('tabSearch'); renderSearch(); });
    function setActive(id){ document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    function renderGroupedByCustomer(){ const area=document.getElementById('listArea'); if(!jobs.length) return area.innerHTML='<div class="muted">No jobs yet.</div>'; const groups={}; jobs.forEach(j=>{ groups[j.customer]=(groups[j.customer]||0)+1 }); let html='<div>'; for(const k in groups) html+=`<div style="padding:6px 0"><strong>${escapeHtml(k)}</strong> &nbsp; <span class="muted">(${groups[k]} jobs)</span></div>`; html+='</div>'; area.innerHTML=html; }
    function renderSearch(){ const area=document.getElementById('listArea'); area.innerHTML = `<div style="display:flex;gap:8px"><input id="q" placeholder="type customer/model/ref" style="flex:1"><button id="doSearch" class="small">Search</button></div><div id="searchResults" style="margin-top:8px"></div>`; document.getElementById('doSearch').addEventListener('click', ()=>{ const q=document.getElementById('q').value.toLowerCase(); const res = jobs.filter(j=> (j.customer||'').toLowerCase().includes(q) || (j.model||'').toLowerCase().includes(q) || (j.refNo||'').toLowerCase().includes(q)); let html=''; if(!res.length) html='<div class="muted">No results</div>'; else html='<table><thead><tr><th>#</th><th>Customer</th><th>Model</th><th>Ref</th><th>Qty</th><th>Actions</th></tr></thead><tbody>'+res.map((j,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(j.customer)}</td><td>${escapeHtml(j.model)}</td><td>${escapeHtml(j.refNo)}</td><td>${j.qty}</td><td><button onclick="editJob(${jobs.indexOf(j)})" class="small">Edit</button></td></tr>`).join('')+'</tbody></table>'; document.getElementById('searchResults').innerHTML=html; }); }

    // CSV download
    document.getElementById('downloadCsv').addEventListener('click', ()=>{
      if(!jobs.length) return alert('No records');
      const header = ['Customer','Model','RefNo','Qty','Notes','Created'];
      const rows = jobs.map(j=>[j.customer,j.model,j.refNo,j.qty,j.notes,j.createdAt]);
      const csv = [header.join(','),...rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""') }"\`).join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='jobs.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // GitHub integration (simple client-side demo)
    function ghConfig(){
      const user = document.getElementById('ghUser').value.trim();
      const repo = document.getElementById('ghRepo').value.trim();
      const path = document.getElementById('ghPath').value.trim();
      const token = document.getElementById('ghToken').value.trim();
      // persist for session
      sessionStorage.setItem('ghUser',user); sessionStorage.setItem('ghRepo',repo); sessionStorage.setItem('ghPath',path); sessionStorage.setItem('ghToken',token);
      return {user,repo,path,token};
    }

    async function getFileSha(user,repo,path,token){
      const url = `https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`;
      const res = await fetch(url,{headers: token?{Authorization:'token '+token}:{}});
      if(res.status===404) return null;
      if(!res.ok) throw new Error('GitHub GET failed: '+res.status);
      const j = await res.json(); return j.sha;
    }

    async function uploadJobsToGithub(){
      const cfg = ghConfig();
      if(!cfg.user||!cfg.repo||!cfg.path) return alert('Set GitHub owner/repo/path first');
      try{
        // build workbook with SheetJS
        const ws = XLSX.utils.json_to_sheet(jobs.map((j,i)=>({No:i+1,Customer:j.customer,Model:j.model,RefNo:j.refNo,Qty:j.qty,Notes:j.notes,Created:j.createdAt})))
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Jobs');
        const wbout = XLSX.write(wb,{bookType:'xlsx',type:'binary'});
        // convert binary to base64
        function s2ab(s){ const buf = new ArrayBuffer(s.length); const view = new Uint8Array(buf); for(var i=0;i<s.length;i++) view[i]=s.charCodeAt(i)&0xFF; return buf; }
        const blob = new Blob([s2ab(wbout)],{type:'application/octet-stream'});
        const arrayBuffer = await blob.arrayBuffer();
        let binary = '';
        const bytes = new Uint8Array(arrayBuffer);
        const chunk = 0x8000;
        for (let i=0; i<bytes.length; i+=chunk) {
          binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
        }
        const contentBase64 = btoa(binary);

        const sha = await getFileSha(cfg.user,cfg.repo,cfg.path,cfg.token);
        const url = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${encodeURIComponent(cfg.path)}`;
        const body = { message: sha? 'Update jobs.xlsx from web UI' : 'Create jobs.xlsx from web UI', content: contentBase64 };
        if(sha) body.sha = sha;
        const res = await fetch(url,{method:'PUT',headers: {'Content-Type':'application/json', ...(cfg.token?{Authorization:'token '+cfg.token}:{})}, body: JSON.stringify(body)});
        const j = await res.json();
        if(!res.ok) throw new Error(JSON.stringify(j));
        alert('Uploaded to GitHub: ' + (j.content && j.content.path));
        return j;
      }catch(err){ console.error(err); alert('Upload failed: '+err.message||err); }
    }

    async function downloadJobsFromGithub(){
      const cfg = ghConfig();
      if(!cfg.user||!cfg.repo||!cfg.path) return alert('Set GitHub owner/repo/path first');
      const url = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${encodeURIComponent(cfg.path)}`;
      const res = await fetch(url,{headers: cfg.token?{Authorization:'token '+cfg.token}:{}});
      if(res.status===404) return alert('File not found on repository');
      if(!res.ok) return alert('Failed to fetch: '+res.status);
      const j = await res.json();
      const base64 = j.content.replace(/\n/g,'');
      const binary = atob(base64);
      // try parse with SheetJS
      const buf = new Uint8Array(binary.length);
      for(let i=0;i<binary.length;i++) buf[i]=binary.charCodeAt(i);
      const wb = XLSX.read(buf,{type:'array'});
      const first = wb.SheetNames[0];
      const arr = XLSX.utils.sheet_to_json(wb.Sheets[first]);
      // normalize to jobs format
      jobs = arr.map(r=>({ customer:r.Customer||r.customer||'', model:r.Model||r.model||'', refNo:r.RefNo||r.RefNo||r.refNo||'', qty:Number(r.Qty||r.qty||0)||0, notes:r.Notes||r.notes||'', createdAt:r.Created||new Date().toISOString() }));
      saveLocalData(); renderList(); alert('Loaded '+jobs.length+' jobs from GitHub');
    }

    // Auto upload option
    async function maybeAutoUpload(){
      const token = document.getElementById('ghToken').value.trim();
      const auto = !!token; // simple rule: if token present, upload
      if(auto){ // don't block UI
        uploadJobsToGithub().catch(e=>console.warn('auto upload failed',e));
      }
    }

    document.getElementById('syncGithub').addEventListener('click', ()=>{ uploadJobsToGithub(); });
    document.getElementById('testDownload').addEventListener('click', ()=>{ downloadJobsFromGithub(); });
    document.getElementById('loadFromLocal').addEventListener('click', ()=>{ jobs = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); renderList(); });
    document.getElementById('clearLocal').addEventListener('click', ()=>{ if(confirm('Clear local saved jobs?')){ jobs=[]; saveLocalData(); renderList(); }});

    // on load
    renderList();
  </script>
</body>
</html>
